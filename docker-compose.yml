services:
  mongo:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  mcp_server:
    build: ./mcp_server
    environment:
      - DATA_DIR=/data/sample
    volumes:
      - ./mcp_server:/app
      - ./data:/data
    ports:
      - "7000:7000"
    depends_on:
      - mongo

  orchestrator:
    build: ./orchestrator
    environment:
      - ORCH_PORT=4000
      - MCP_URL=http://mcp_server:7000
      - MONGO_URI=mongodb://mongo:27017
      - MONGO_DB=utrahacks
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=gemini-1.5-flash
    env_file:
      - .env
    volumes:
      - ./orchestrator:/app
      - orchestrator_node_modules:/app/node_modules
    ports:
      - "4000:4000"
    depends_on:
      - mongo
      - mcp_server
    command: sh -c "npm install && npm run dev"

  frontend:
    build: ./frontend
    environment:
      - NEXT_PUBLIC_ORCHESTRATOR_URL=http://localhost:4000
    env_file:
      - .env
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "3000:3000"
    depends_on:
      - orchestrator

  precache:
    build: ./mcp_server
    command: python /app/scripts/precache_amenities.py
    environment:
      - MCP_URL=http://mcp_server:7000/mcp
    volumes:
      - ./mcp_server:/app
      - ./scripts:/app/scripts
    depends_on:
      - mcp_server
      - mongo

volumes:
  mongo_data:
  frontend_node_modules:
  orchestrator_node_modules:
